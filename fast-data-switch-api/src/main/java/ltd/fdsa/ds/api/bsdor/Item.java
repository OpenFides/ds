package ltd.fdsa.ds.api.bsdor;

import com.google.common.base.Strings;
import lombok.var;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

/*
 * 自描述数据结构
 * 第一个byte作为类型，根据类型不同: 定长时，直取内容；变长时，取N个bytes作为内容的长度length。再取length个类型的单元作为内容；
 * */
public interface Item<T> {
    static Map createFromByteArray(byte[] input) {
        Map<String, Object> map = new HashMap<String, Object>();
        DataParse parse = new DataParse(new ByteArrayInputStream(input));
        while (true) {
            var key = parse.Parse();
            if (key == null || key instanceof NullItem) {
                return map;
            }
            var value = parse.Parse();
            map.put(key.getValue().toString(), value.getValue());
        }
    }

    static byte[] toByteArray(Map<String, Item> map) {
        ByteArrayOutputStream buffer = new ByteArrayOutputStream();
        for (var entry : map.entrySet()) {
            var key = entry.getKey();
            if (Strings.isNullOrEmpty(key)) {
                buffer.write(Type.EMPTY.value);
            } else {
                try {
                    buffer.write(new StringItem(key).toByteArray());
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
            var value = entry.getValue();
            try {
                buffer.write(value.toByteArray());
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return buffer.toByteArray();
    }

    byte[] toByteArray();

    T getValue();

    Type getType();

    enum Type {

        NULL(0B00000000),
        P_NUM001(0B00000001),
        P_NUM002(0B00000010),
        P_NUM003(0B00000011),
        P_NUM004(0B00000100),
        P_NUM005(0B00000101),
        P_NUM006(0B00000110),
        P_NUM007(0B00000111),
        P_NUM008(0B00001000),
        P_NUM009(0B00001001),
        P_NUM010(0B00001010),
        P_NUM011(0B00001011),
        P_NUM012(0B00001100),
        P_NUM013(0B00001101),
        P_NUM014(0B00001110),
        P_NUM015(0B00001111),
        P_NUM016(0B00010000),
        P_NUM017(0B00010001),
        P_NUM018(0B00010010),
        P_NUM019(0B00010011),
        P_NUM020(0B00010100),
        P_NUM021(0B00010101),
        P_NUM022(0B00010110),
        P_NUM023(0B00010111),
        P_NUM024(0B00011000),
        P_NUM025(0B00011001),
        P_NUM026(0B00011010),
        P_NUM027(0B00011011),
        P_NUM028(0B00011100),
        P_NUM029(0B00011101),
        P_NUM030(0B00011110),
        P_NUM031(0B00011111),
        P_NUM032(0B00100000),
        P_NUM033(0B00100001),
        P_NUM034(0B00100010),
        P_NUM035(0B00100011),
        P_NUM036(0B00100100),
        P_NUM037(0B00100101),
        P_NUM038(0B00100110),
        P_NUM039(0B00100111),
        P_NUM040(0B00101000),
        P_NUM041(0B00101001),
        P_NUM042(0B00101010),
        P_NUM043(0B00101011),
        P_NUM044(0B00101100),
        P_NUM045(0B00101101),
        P_NUM046(0B00101110),
        P_NUM047(0B00101111),
        P_NUM048(0B00110000),
        P_NUM049(0B00110001),
        P_NUM050(0B00110010),
        P_NUM051(0B00110011),
        P_NUM052(0B00110100),
        P_NUM053(0B00110101),
        P_NUM054(0B00110110),
        P_NUM055(0B00110111),
        P_NUM056(0B00111000),
        P_NUM057(0B00111001),
        P_NUM058(0B00111010),
        P_NUM059(0B00111011),
        P_NUM8(0B00111100),
        P_NUM16(0B00111101),
        P_NUM32(0B00111110),
        P_NUM64(0B00111111),
        EMPTY(0B01000000),
        STR1(0B01000001),
        STR2(0B01000010),
        STR3(0B01000011),
        STR4(0B01000100),
        STR5(0B01000101),
        STR6(0B01000110),
        STR7(0B01000111),
        STR8(0B01001000),
        STR9(0B01001001),
        STR10(0B01001010),
        STR11(0B01001011),
        STR12(0B01001100),
        STR13(0B01001101),
        STR14(0B01001110),
        STR15(0B01001111),
        STR16(0B01010000),
        STR17(0B01010001),
        STR18(0B01010010),
        STR19(0B01010011),
        STR20(0B01010100),
        STR21(0B01010101),
        STR22(0B01010110),
        STR23(0B01010111),
        STR24(0B01011000),
        STR25(0B01011001),
        STR26(0B01011010),
        STR27(0B01011011),
        STR28(0B01011100),
        STR29(0B01011101),
        STR30(0B01011110),
        STR31(0B01011111),
        STR32(0B01100000),
        STR33(0B01100001),
        STR34(0B01100010),
        STR35(0B01100011),
        STR36(0B01100100),
        STR37(0B01100101),
        STR38(0B01100110),
        STR39(0B01100111),
        STR40(0B01101000),
        STR41(0B01101001),
        STR42(0B01101010),
        STR43(0B01101011),
        STR44(0B01101100),
        STR45(0B01101101),
        STR46(0B01101110),
        STR47(0B01101111),
        STR48(0B01110000),
        STR49(0B01110001),
        STR50(0B01110010),
        STR51(0B01110011),
        STR52(0B01110100),
        STR53(0B01110101),
        STR54(0B01110110),
        STR55(0B01110111),
        STR56(0B01111000),
        STR57(0B01111001),
        STR58(0B01111010),
        STR59(0B01111011),
        STR60(0B01111100),
        STR61(0B01111101),
        STR62(0B01111110),
        STRINGS(0B01111111),
        FALSE(0B10000000),
        TRUE(0B10000001),
        FLOAT(0B10000010),
        DOUBLE(0B10000011),
        TIMESTAMP(0B10000100),
        DECIMAL(0B10000101),
        BYTES(0B10000110),
        REF(0B10000111),
        RESERVE1(0B10001000),
        RESERVE2(0B10001001),
        RESERVE3(0B10001010),
        RESERVE4(0B10001011),
        RESERVE5(0B10001100),
        RESERVE6(0B10001101),
        RESERVE7(0B10001110),
        P_NUM060(0B10001111),
        P_NUM061(0B10010000),
        P_NUM062(0B10010001),
        P_NUM063(0B10010010),
        P_NUM064(0B10010011),
        P_NUM065(0B10010100),
        P_NUM066(0B10010101),
        P_NUM067(0B10010110),
        P_NUM068(0B10010111),
        P_NUM069(0B10011000),
        P_NUM070(0B10011001),
        P_NUM071(0B10011010),
        P_NUM072(0B10011011),
        P_NUM073(0B10011100),
        P_NUM074(0B10011101),
        P_NUM075(0B10011110),
        P_NUM076(0B10011111),
        P_NUM077(0B10100000),
        P_NUM078(0B10100001),
        P_NUM079(0B10100010),
        P_NUM080(0B10100011),
        P_NUM081(0B10100100),
        P_NUM082(0B10100101),
        P_NUM083(0B10100110),
        P_NUM084(0B10100111),
        P_NUM085(0B10101000),
        P_NUM086(0B10101001),
        P_NUM087(0B10101010),
        P_NUM088(0B10101011),
        P_NUM089(0B10101100),
        P_NUM090(0B10101101),
        P_NUM091(0B10101110),
        P_NUM092(0B10101111),
        P_NUM093(0B10110000),
        P_NUM094(0B10110001),
        P_NUM095(0B10110010),
        P_NUM096(0B10110011),
        P_NUM097(0B10110100),
        P_NUM098(0B10110101),
        P_NUM099(0B10110110),
        P_NUM100(0B10110111),
        P_NUM101(0B10111000),
        P_NUM102(0B10111001),
        P_NUM103(0B10111010),
        P_NUM104(0B10111011),
        P_NUM105(0B10111100),
        P_NUM106(0B10111101),
        P_NUM107(0B10111110),
        P_NUM108(0B10111111),
        ZERO(0B11000000),
        N_NUM001(0B11000001),
        N_NUM002(0B11000010),
        N_NUM003(0B11000011),
        N_NUM004(0B11000100),
        N_NUM005(0B11000101),
        N_NUM006(0B11000110),
        N_NUM007(0B11000111),
        N_NUM008(0B11001000),
        N_NUM009(0B11001001),
        N_NUM010(0B11001010),
        N_NUM011(0B11001011),
        N_NUM012(0B11001100),
        N_NUM013(0B11001101),
        N_NUM014(0B11001110),
        N_NUM015(0B11001111),
        N_NUM016(0B11010000),
        N_NUM017(0B11010001),
        N_NUM018(0B11010010),
        N_NUM019(0B11010011),
        N_NUM020(0B11010100),
        N_NUM021(0B11010101),
        N_NUM022(0B11010110),
        N_NUM023(0B11010111),
        N_NUM024(0B11011000),
        N_NUM025(0B11011001),
        N_NUM026(0B11011010),
        N_NUM027(0B11011011),
        N_NUM028(0B11011100),
        N_NUM029(0B11011101),
        N_NUM030(0B11011110),
        N_NUM031(0B11011111),
        N_NUM032(0B11100000),
        N_NUM033(0B11100001),
        N_NUM034(0B11100010),
        N_NUM035(0B11100011),
        N_NUM036(0B11100100),
        N_NUM037(0B11100101),
        N_NUM038(0B11100110),
        N_NUM039(0B11100111),
        N_NUM040(0B11101000),
        N_NUM041(0B11101001),
        N_NUM042(0B11101010),
        N_NUM043(0B11101011),
        N_NUM044(0B11101100),
        N_NUM045(0B11101101),
        N_NUM046(0B11101110),
        N_NUM047(0B11101111),
        N_NUM048(0B11110000),
        N_NUM049(0B11110001),
        N_NUM050(0B11110010),
        N_NUM051(0B11110011),
        N_NUM052(0B11110100),
        N_NUM053(0B11110101),
        N_NUM054(0B11110110),
        N_NUM055(0B11110111),
        N_NUM056(0B11111000),
        N_NUM057(0B11111001),
        N_NUM058(0B11111010),
        N_NUM059(0B11111011),
        N_NUM8(0B11111100),
        N_NUM16(0B11111101),
        N_NUM32(0B11111110),
        N_NUM64(0B11111111),
        ;

        private final short value;
        private static final Type[] TYPES;
        private static final Type[] N_NUMS;
        private static final Type[] P_NUMS;

        static {
            P_NUMS = new Type[]{
                    ZERO,
                    P_NUM001,
                    P_NUM002,
                    P_NUM003,
                    P_NUM004,
                    P_NUM005,
                    P_NUM006,
                    P_NUM007,
                    P_NUM008,
                    P_NUM009,
                    P_NUM010,
                    P_NUM011,
                    P_NUM012,
                    P_NUM013,
                    P_NUM014,
                    P_NUM015,
                    P_NUM016,
                    P_NUM017,
                    P_NUM018,
                    P_NUM019,
                    P_NUM020,
                    P_NUM021,
                    P_NUM022,
                    P_NUM023,
                    P_NUM024,
                    P_NUM025,
                    P_NUM026,
                    P_NUM027,
                    P_NUM028,
                    P_NUM029,
                    P_NUM030,
                    P_NUM031,
                    P_NUM032,
                    P_NUM033,
                    P_NUM034,
                    P_NUM035,
                    P_NUM036,
                    P_NUM037,
                    P_NUM038,
                    P_NUM039,
                    P_NUM040,
                    P_NUM041,
                    P_NUM042,
                    P_NUM043,
                    P_NUM044,
                    P_NUM045,
                    P_NUM046,
                    P_NUM047,
                    P_NUM048,
                    P_NUM049,
                    P_NUM050,
                    P_NUM051,
                    P_NUM052,
                    P_NUM053,
                    P_NUM054,
                    P_NUM055,
                    P_NUM056,
                    P_NUM057,
                    P_NUM058,
                    P_NUM059,
                    P_NUM060,
                    P_NUM061,
                    P_NUM062,
                    P_NUM063,
                    P_NUM064,
                    P_NUM065,
                    P_NUM066,
                    P_NUM067,
                    P_NUM068,
                    P_NUM069,
                    P_NUM070,
                    P_NUM071,
                    P_NUM072,
                    P_NUM073,
                    P_NUM074,
                    P_NUM075,
                    P_NUM076,
                    P_NUM077,
                    P_NUM078,
                    P_NUM079,
                    P_NUM080,
                    P_NUM081,
                    P_NUM082,
                    P_NUM083,
                    P_NUM084,
                    P_NUM085,
                    P_NUM086,
                    P_NUM087,
                    P_NUM088,
                    P_NUM089,
                    P_NUM090,
                    P_NUM091,
                    P_NUM092,
                    P_NUM093,
                    P_NUM094,
                    P_NUM095,
                    P_NUM096,
                    P_NUM097,
                    P_NUM098,
                    P_NUM099,
                    P_NUM100,
                    P_NUM101,
                    P_NUM102,
                    P_NUM103,
                    P_NUM104,
                    P_NUM105,
                    P_NUM106,
                    P_NUM107,
                    P_NUM108,
                    P_NUM8,
                    P_NUM16,
                    P_NUM32,
                    P_NUM64,
            };
            N_NUMS = new Type[]{
                    ZERO,
                    N_NUM001,
                    N_NUM002,
                    N_NUM003,
                    N_NUM004,
                    N_NUM005,
                    N_NUM006,
                    N_NUM007,
                    N_NUM008,
                    N_NUM009,
                    N_NUM010,
                    N_NUM011,
                    N_NUM012,
                    N_NUM013,
                    N_NUM014,
                    N_NUM015,
                    N_NUM016,
                    N_NUM017,
                    N_NUM018,
                    N_NUM019,
                    N_NUM020,
                    N_NUM021,
                    N_NUM022,
                    N_NUM023,
                    N_NUM024,
                    N_NUM025,
                    N_NUM026,
                    N_NUM027,
                    N_NUM028,
                    N_NUM029,
                    N_NUM030,
                    N_NUM031,
                    N_NUM032,
                    N_NUM033,
                    N_NUM034,
                    N_NUM035,
                    N_NUM036,
                    N_NUM037,
                    N_NUM038,
                    N_NUM039,
                    N_NUM040,
                    N_NUM041,
                    N_NUM042,
                    N_NUM043,
                    N_NUM044,
                    N_NUM045,
                    N_NUM046,
                    N_NUM047,
                    N_NUM048,
                    N_NUM049,
                    N_NUM050,
                    N_NUM051,
                    N_NUM052,
                    N_NUM053,
                    N_NUM054,
                    N_NUM055,
                    N_NUM056,
                    N_NUM057,
                    N_NUM058,
                    N_NUM059,
                    N_NUM8,
                    N_NUM16,
                    N_NUM32,
                    N_NUM64,
            };
            TYPES = new Type[]{
                    NULL,
                    P_NUM001,
                    P_NUM002,
                    P_NUM003,
                    P_NUM004,
                    P_NUM005,
                    P_NUM006,
                    P_NUM007,
                    P_NUM008,
                    P_NUM009,
                    P_NUM010,
                    P_NUM011,
                    P_NUM012,
                    P_NUM013,
                    P_NUM014,
                    P_NUM015,
                    P_NUM016,
                    P_NUM017,
                    P_NUM018,
                    P_NUM019,
                    P_NUM020,
                    P_NUM021,
                    P_NUM022,
                    P_NUM023,
                    P_NUM024,
                    P_NUM025,
                    P_NUM026,
                    P_NUM027,
                    P_NUM028,
                    P_NUM029,
                    P_NUM030,
                    P_NUM031,
                    P_NUM032,
                    P_NUM033,
                    P_NUM034,
                    P_NUM035,
                    P_NUM036,
                    P_NUM037,
                    P_NUM038,
                    P_NUM039,
                    P_NUM040,
                    P_NUM041,
                    P_NUM042,
                    P_NUM043,
                    P_NUM044,
                    P_NUM045,
                    P_NUM046,
                    P_NUM047,
                    P_NUM048,
                    P_NUM049,
                    P_NUM050,
                    P_NUM051,
                    P_NUM052,
                    P_NUM053,
                    P_NUM054,
                    P_NUM055,
                    P_NUM056,
                    P_NUM057,
                    P_NUM058,
                    P_NUM059,
                    P_NUM8,
                    P_NUM16,
                    P_NUM32,
                    P_NUM64,
                    EMPTY,
                    STR1,
                    STR2,
                    STR3,
                    STR4,
                    STR5,
                    STR6,
                    STR7,
                    STR8,
                    STR9,
                    STR10,
                    STR11,
                    STR12,
                    STR13,
                    STR14,
                    STR15,
                    STR16,
                    STR17,
                    STR18,
                    STR19,
                    STR20,
                    STR21,
                    STR22,
                    STR23,
                    STR24,
                    STR25,
                    STR26,
                    STR27,
                    STR28,
                    STR29,
                    STR30,
                    STR31,
                    STR32,
                    STR33,
                    STR34,
                    STR35,
                    STR36,
                    STR37,
                    STR38,
                    STR39,
                    STR40,
                    STR41,
                    STR42,
                    STR43,
                    STR44,
                    STR45,
                    STR46,
                    STR47,
                    STR48,
                    STR49,
                    STR50,
                    STR51,
                    STR52,
                    STR53,
                    STR54,
                    STR55,
                    STR56,
                    STR57,
                    STR58,
                    STR59,
                    STR60,
                    STR61,
                    STR62,
                    STRINGS,
                    FALSE,
                    TRUE,
                    FLOAT,
                    DOUBLE,
                    TIMESTAMP,
                    DECIMAL,
                    BYTES,
                    REF,
                    RESERVE1,
                    RESERVE2,
                    RESERVE3,
                    RESERVE4,
                    RESERVE5,
                    RESERVE6,
                    RESERVE7,
                    P_NUM060,
                    P_NUM061,
                    P_NUM062,
                    P_NUM063,
                    P_NUM064,
                    P_NUM065,
                    P_NUM066,
                    P_NUM067,
                    P_NUM068,
                    P_NUM069,
                    P_NUM070,
                    P_NUM071,
                    P_NUM072,
                    P_NUM073,
                    P_NUM074,
                    P_NUM075,
                    P_NUM076,
                    P_NUM077,
                    P_NUM078,
                    P_NUM079,
                    P_NUM080,
                    P_NUM081,
                    P_NUM082,
                    P_NUM083,
                    P_NUM084,
                    P_NUM085,
                    P_NUM086,
                    P_NUM087,
                    P_NUM088,
                    P_NUM089,
                    P_NUM090,
                    P_NUM091,
                    P_NUM092,
                    P_NUM093,
                    P_NUM094,
                    P_NUM095,
                    P_NUM096,
                    P_NUM097,
                    P_NUM098,
                    P_NUM099,
                    P_NUM100,
                    P_NUM101,
                    P_NUM102,
                    P_NUM103,
                    P_NUM104,
                    P_NUM105,
                    P_NUM106,
                    P_NUM107,
                    P_NUM108,
                    ZERO,
                    N_NUM001,
                    N_NUM002,
                    N_NUM003,
                    N_NUM004,
                    N_NUM005,
                    N_NUM006,
                    N_NUM007,
                    N_NUM008,
                    N_NUM009,
                    N_NUM010,
                    N_NUM011,
                    N_NUM012,
                    N_NUM013,
                    N_NUM014,
                    N_NUM015,
                    N_NUM016,
                    N_NUM017,
                    N_NUM018,
                    N_NUM019,
                    N_NUM020,
                    N_NUM021,
                    N_NUM022,
                    N_NUM023,
                    N_NUM024,
                    N_NUM025,
                    N_NUM026,
                    N_NUM027,
                    N_NUM028,
                    N_NUM029,
                    N_NUM030,
                    N_NUM031,
                    N_NUM032,
                    N_NUM033,
                    N_NUM034,
                    N_NUM035,
                    N_NUM036,
                    N_NUM037,
                    N_NUM038,
                    N_NUM039,
                    N_NUM040,
                    N_NUM041,
                    N_NUM042,
                    N_NUM043,
                    N_NUM044,
                    N_NUM045,
                    N_NUM046,
                    N_NUM047,
                    N_NUM048,
                    N_NUM049,
                    N_NUM050,
                    N_NUM051,
                    N_NUM052,
                    N_NUM053,
                    N_NUM054,
                    N_NUM055,
                    N_NUM056,
                    N_NUM057,
                    N_NUM058,
                    N_NUM059,
                    N_NUM8,
                    N_NUM16,
                    N_NUM32,
                    N_NUM64,
            };
        }

        public static Type valueOf(int value) {
            return TYPES[value];
        }

        public static Type numberOf(int value) {
            if (value >= 0) {
                return P_NUMS[value];
            }
            return N_NUMS[-value];
        }

        Type(Integer value) {
            this.value = value.shortValue();
        }

        public Short getValue() {
            return value;
        }

        public int getMainType() {
            return this.value >> 6;
        }

        public int getSubType() {
            return this.value & 0B00111111;
        }
    }
}
